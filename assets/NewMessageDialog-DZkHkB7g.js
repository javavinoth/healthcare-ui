import{t as H,j as e,I as _,M as ae,a7 as N,s as re,u as q,b as U,E as B,r as w,G,F as ne,B as I,V as D,v as J,w as P,ae as le,az as ie,y as W,z as Z,X as ce,aA as i,N as oe,O as de,P as ue,Q as me,L as z,l as he,n as fe,o as xe,p as ge,q as pe}from"./index-92FsJMKL.js";import{S as C}from"./skeleton-DmCllHn_.js";import{c as be,S as ee,i as ye,a as je}from"./scroll-area-Ud2Ez727.js";import{E as Ne}from"./EmptyState-Cs_zZtcs.js";import{S as K}from"./search-DjYMh_51.js";import{t as R,n as X,b as Q,g as ve,e as Se,d as V,h as L,f as $}from"./format-BLBLR528.js";import{e as Me}from"./endOfMonth-BVjs0DFG.js";import{u as Y}from"./useQuery-BtA2DJKW.js";import{D as we}from"./download-PfJdG8Wc.js";import{T as se}from"./textarea-4c9PP0iO.js";import{P as De}from"./paperclip-qYVI0E0R.js";/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Te=[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",ry:"2",key:"1m3agn"}],["circle",{cx:"9",cy:"9",r:"2",key:"af1f0g"}],["path",{d:"m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21",key:"1xmnt7"}]],Ie=H("image",Te);/**
 * @license lucide-react v0.546.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Re=[["path",{d:"M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z",key:"1ffxy3"}],["path",{d:"m21.854 2.147-10.94 10.939",key:"12cjpa"}]],Ee=H("send",Re);function k(s,a){const l=+R(s)-+R(a);return l<0?-1:l>0?1:l}function Ae(s,a,l){const[u,t]=X(l?.in,s,a),r=u.getFullYear()-t.getFullYear(),f=u.getMonth()-t.getMonth();return r*12+f}function Fe(s){return a=>{const u=(s?Math[s]:Math.trunc)(a);return u===0?0:u}}function Ce(s,a){return+R(s)-+R(a)}function Oe(s,a){const l=R(s,a?.in);return l.setHours(23,59,59,999),l}function Pe(s,a){const l=R(s,a?.in);return+Oe(l,a)==+Me(l,a)}function Le(s,a,l){const[u,t,r]=X(l?.in,s,s,a),f=k(t,r),n=Math.abs(Ae(t,r));if(n<1)return 0;t.getMonth()===1&&t.getDate()>27&&t.setDate(30),t.setMonth(t.getMonth()-f*n);let h=k(t,r)===-f;Pe(u)&&n===1&&k(u,r)===1&&(h=!1);const j=f*(n-+h);return j===0?0:j}function ke(s,a,l){const u=Ce(s,a)/1e3;return Fe(l?.roundingMethod)(u)}function ze(s,a,l){const u=ve(),t=l?.locale??u.locale??Se,r=2520,f=k(s,a);if(isNaN(f))throw new RangeError("Invalid time value");const n=Object.assign({},l,{addSuffix:l?.addSuffix,comparison:f}),[h,j]=X(l?.in,...f>0?[a,s]:[s,a]),x=ke(j,h),v=(Q(j)-Q(h))/1e3,d=Math.round((x-v)/60);let g;if(d<2)return l?.includeSeconds?x<5?t.formatDistance("lessThanXSeconds",5,n):x<10?t.formatDistance("lessThanXSeconds",10,n):x<20?t.formatDistance("lessThanXSeconds",20,n):x<40?t.formatDistance("halfAMinute",0,n):x<60?t.formatDistance("lessThanXMinutes",1,n):t.formatDistance("xMinutes",1,n):d===0?t.formatDistance("lessThanXMinutes",1,n):t.formatDistance("xMinutes",d,n);if(d<45)return t.formatDistance("xMinutes",d,n);if(d<90)return t.formatDistance("aboutXHours",1,n);if(d<V){const b=Math.round(d/60);return t.formatDistance("aboutXHours",b,n)}else{if(d<r)return t.formatDistance("xDays",1,n);if(d<L){const b=Math.round(d/V);return t.formatDistance("xDays",b,n)}else if(d<L*2)return g=Math.round(d/L),t.formatDistance("aboutXMonths",g,n)}if(g=Le(j,h),g<12){const b=Math.round(d/L);return t.formatDistance("xMonths",b,n)}else{const b=g%12,m=Math.trunc(g/12);return b<3?t.formatDistance("aboutXYears",m,n):b<9?t.formatDistance("overXYears",m,n):t.formatDistance("almostXYears",m+1,n)}}function _e(s,a){return ze(s,be(s),a)}function ts({conversations:s,selectedId:a,onSelect:l,isLoading:u=!1}){const t=r=>{console.log("Search:",r.target.value)};return u?e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsxs("div",{className:"p-4 border-b border-neutral-blue-gray/10",children:[e.jsx("h2",{className:"text-h2 text-neutral-blue-gray mb-3",children:"Messages"}),e.jsx(C,{className:"h-10 w-full"})]}),e.jsx("div",{className:"flex-1 p-4 space-y-3",children:[1,2,3,4,5].map(r=>e.jsx(C,{className:"h-20 w-full"},r))})]}):s.length===0?e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsxs("div",{className:"p-4 border-b border-neutral-blue-gray/10",children:[e.jsx("h2",{className:"text-h2 text-neutral-blue-gray mb-3",children:"Messages"}),e.jsxs("div",{className:"relative",children:[e.jsx(K,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-neutral-blue-gray/50"}),e.jsx(_,{type:"text",placeholder:"Search conversations...",className:"pl-10",onChange:t})]})]}),e.jsx("div",{className:"flex-1 flex items-center justify-center p-4",children:e.jsx(Ne,{icon:ae,title:"No conversations",description:"Start a conversation with your healthcare provider to see it here."})})]}):e.jsxs("div",{className:"flex flex-col h-full bg-white",children:[e.jsxs("div",{className:"p-4 border-b border-neutral-blue-gray/10",children:[e.jsx("h2",{className:"text-h2 text-neutral-blue-gray mb-3",children:"Messages"}),e.jsxs("div",{className:"relative",children:[e.jsx(K,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-neutral-blue-gray/50"}),e.jsx(_,{type:"text",placeholder:"Search conversations...",className:"pl-10",onChange:t,"aria-label":"Search conversations"})]})]}),e.jsx(ee,{className:"flex-1",children:e.jsx("div",{className:"divide-y divide-neutral-blue-gray/10",children:s.map(r=>{const f=r.id===a,n=r.unreadCount>0,h=r.participants[0];return e.jsx("button",{onClick:()=>l(r.id),className:N("w-full p-4 text-left transition-colors hover:bg-neutral-light focus:outline-none focus:ring-2 focus:ring-primary focus:ring-inset",f&&"bg-primary/5 border-l-4 border-l-primary",n&&!f&&"bg-info/5"),"aria-label":`Conversation with ${h?.name}`,"aria-current":f?"true":"false",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx("div",{className:N("w-12 h-12 rounded-full flex items-center justify-center text-white font-semibold",h?.role==="doctor"&&"bg-primary",h?.role==="nurse"&&"bg-info",h?.role==="patient"&&"bg-wellness"),children:h?.name?.split(" ").map(j=>j[0]).join("").toUpperCase()||"?"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-start justify-between gap-2 mb-1",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:N("text-body truncate",n?"font-semibold text-neutral-blue-gray":"font-medium text-neutral-blue-gray"),children:h?.name||"Unknown"}),e.jsx("p",{className:"text-caption text-neutral-blue-gray/60 capitalize",children:h?.role||"Unknown role"})]}),n&&e.jsx(re,{variant:"default",className:"bg-primary text-white ml-2",children:r.unreadCount})]}),e.jsx("p",{className:N("text-small truncate mb-1",n?"font-medium text-neutral-blue-gray":"text-neutral-blue-gray/80"),children:r.subject}),r.lastMessage&&e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("p",{className:"text-caption text-neutral-blue-gray/60 truncate flex-1",children:r.lastMessage.content}),e.jsx("p",{className:"text-caption text-neutral-blue-gray/50 flex-shrink-0",children:_e(new Date(r.lastMessage.sentAt),{addSuffix:!0})})]})]})]})},r.id)})})})]})}function as({conversationId:s}){const{user:a}=q(),{toast:l}=U(),u=B(),t=w.useRef(null),r=w.useRef(null),{data:f,isLoading:n,error:h}=Y({queryKey:["messages",s],queryFn:()=>D.getMessages(s),refetchInterval:1e4,enabled:!!s}),j=G({mutationFn:m=>D.markAsRead(m),onSuccess:()=>{u.invalidateQueries({queryKey:["conversations"]}),u.invalidateQueries({queryKey:["messages",s]})}}),x=f?.data||[];w.useEffect(()=>{x.length>0&&r.current?.scrollIntoView({behavior:"smooth"})},[x.length]),w.useEffect(()=>{if(!a||!x.length)return;x.filter(c=>!c.isRead&&c.senderId!==a.id).forEach(c=>{j.mutate(c.id)})},[x,a]);const v=m=>ye(m)?"Today":je(m)?"Yesterday":$(m,"MMMM d, yyyy"),d=[];let g=null;x.forEach(m=>{const c=new Date(m.sentAt),y=v(c);!g||g.date!==y?(g={date:y,messages:[m]},d.push(g)):g.messages.push(m)});const b=async m=>{try{const c=await D.downloadAttachment(m.id);l({title:"Attachment Info",description:c.message||`${m.name} - File storage not implemented yet`,variant:"default"}),console.log("Attachment download response:",c)}catch(c){l({title:"Download failed",description:c?.message||"Unable to download attachment",variant:"destructive"})}};return n?e.jsxs("div",{className:"flex-1 flex flex-col bg-neutral-light",children:[e.jsxs("div",{className:"p-4 border-b border-neutral-blue-gray/10 bg-white",children:[e.jsx(C,{className:"h-6 w-48 mb-2"}),e.jsx(C,{className:"h-4 w-32"})]}),e.jsx("div",{className:"flex-1 p-4 space-y-4",children:[1,2,3,4].map(m=>e.jsx(C,{className:"h-24 w-3/4"},m))})]}):h?e.jsx("div",{className:"flex-1 flex items-center justify-center bg-neutral-light",children:e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-error mb-2",children:"Failed to load messages"}),e.jsx("p",{className:"text-small text-neutral-blue-gray/60",children:"Please try again later"})]})}):x.length===0?e.jsx("div",{className:"flex-1 flex items-center justify-center bg-neutral-light",children:e.jsx("div",{className:"text-center",children:e.jsx("p",{className:"text-body text-neutral-blue-gray/60",children:"No messages yet. Start the conversation below."})})}):e.jsx(ee,{className:"flex-1 bg-neutral-light",ref:t,children:e.jsxs("div",{className:"p-4 space-y-6",children:[d.map(m=>e.jsxs("div",{children:[e.jsx("div",{className:"flex items-center justify-center mb-4",children:e.jsx("div",{className:"bg-neutral-blue-gray/10 text-neutral-blue-gray/70 text-caption px-3 py-1 rounded-full",children:m.date})}),e.jsx("div",{className:"space-y-4",children:m.messages.map(c=>{const y=c.senderId===a?.id,E=$(new Date(c.sentAt),"h:mm a");return e.jsx("div",{className:N("flex",y?"justify-end":"justify-start"),children:e.jsxs("div",{className:N("max-w-[70%] rounded-lg p-3",y?"bg-primary text-white":"bg-white text-neutral-blue-gray border border-neutral-blue-gray/10"),children:[!y&&e.jsxs("p",{className:"font-semibold text-small mb-1",children:[c.senderName,e.jsxs("span",{className:"text-caption text-neutral-blue-gray/60 ml-2 capitalize",children:["(",c.senderRole,")"]})]}),e.jsx("p",{className:"text-body whitespace-pre-wrap break-words",children:c.content}),c.attachments&&c.attachments.length>0&&e.jsx("div",{className:"mt-3 space-y-2",children:c.attachments.map(S=>{const T=S.type.startsWith("image/");return e.jsxs("div",{className:N("flex items-center gap-2 p-2 rounded border",y?"bg-primary-dark border-white/20":"bg-neutral-light border-neutral-blue-gray/10"),children:[T?e.jsx(Ie,{className:"h-4 w-4 flex-shrink-0"}):e.jsx(ne,{className:"h-4 w-4 flex-shrink-0"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-small truncate",children:S.name}),e.jsxs("p",{className:"text-caption opacity-70",children:[(S.size/1024).toFixed(1)," KB"]})]}),e.jsx(I,{size:"sm",variant:y?"ghost":"outline",onClick:()=>b(S),className:N("h-8 w-8 p-0",y&&"text-white hover:bg-white/10"),children:e.jsx(we,{className:"h-4 w-4"})})]},S.id)})}),e.jsxs("p",{className:N("text-caption mt-2",y?"text-white/70":"text-neutral-blue-gray/50"),children:[E,c.isRead&&y&&e.jsx("span",{className:"ml-2",children:"• Read"})]})]})},c.id)})})]},m.date)),e.jsx("div",{ref:r})]})})}const te=J({recipientId:P().min(1,"Recipient is required"),subject:P().max(500,"Subject is too long (maximum 500 characters)").optional().or(le("")),body:P().min(1,"Message cannot be empty").max(5e3,"Message is too long (maximum 5000 characters)"),conversationId:P().optional()});J({file:ie(File).refine(s=>s.size<=10*1024*1024,{message:"File size must be less than 10MB"}).refine(s=>["application/pdf","image/png","image/jpeg","image/jpg"].includes(s.type),{message:"Only PDF, PNG, and JPEG files are allowed"})});function rs({conversationId:s,recipientId:a}){const{user:l}=q(),{toast:u}=U(),t=B(),[r,f]=w.useState([]),{data:n}=Y({queryKey:["conversation",s],queryFn:()=>s?D.getConversation(s):null,enabled:!!s&&!a}),h=a||n?.participants.find(p=>p.id!==l?.id)?.id||"",{register:j,handleSubmit:x,formState:{errors:v,isSubmitting:d},reset:g,watch:b}=W({resolver:Z(te),defaultValues:{recipientId:h,body:"",conversationId:s}});w.useEffect(()=>{h&&g({recipientId:h,body:b("body"),conversationId:s})},[h,s]);const m=G({mutationFn:p=>D.sendMessage(p),onSuccess:async p=>{if(r.length>0)try{await Promise.all(r.map(o=>D.uploadAttachment(p.id,o)))}catch{u({title:"Attachment upload failed",description:"Message sent but attachments failed to upload.",variant:"destructive"})}g({recipientId:h,body:"",conversationId:s}),f([]),t.invalidateQueries({queryKey:["conversations"]}),t.invalidateQueries({queryKey:["messages",s]}),u({title:"Message sent",description:"Your message has been sent successfully.",variant:"success"})},onError:p=>{u({title:"Failed to send message",description:p?.message||"Please try again.",variant:"destructive"})}}),c=p=>{m.mutate(p)},y=p=>{const F=Array.from(p.target.files||[]).filter(M=>["application/pdf","image/png","image/jpeg","image/jpg"].includes(M.type)?M.size>10485760?(u({title:"File too large",description:`${M.name}: File size must be less than 10MB.`,variant:"destructive"}),!1):!0:(u({title:"Invalid file type",description:`${M.name}: Only PDF, PNG, and JPEG files are allowed.`,variant:"destructive"}),!1));f(M=>[...M,...F]),p.target.value=""},E=p=>{f(o=>o.filter((F,M)=>M!==p))},S=b("body"),T=S?.length||0,A=5e3,O=T>A*.9;return e.jsx("div",{className:"border-t border-neutral-blue-gray/10 bg-white p-4",children:e.jsxs("form",{onSubmit:x(c),className:"space-y-3",children:[r.length>0&&e.jsx("div",{className:"flex flex-wrap gap-2",children:r.map((p,o)=>e.jsxs("div",{className:"flex items-center gap-2 bg-neutral-light border border-neutral-blue-gray/10 rounded px-3 py-2",children:[e.jsx("span",{className:"text-small text-neutral-blue-gray truncate max-w-[200px]",children:p.name}),e.jsx(I,{type:"button",size:"sm",variant:"ghost",onClick:()=>E(o),className:"h-5 w-5 p-0 hover:bg-error/10 hover:text-error",children:e.jsx(ce,{className:"h-3 w-3"})})]},o))}),e.jsxs("div",{className:"relative",children:[e.jsx(se,{...j("body"),placeholder:"Type your message here...",className:N("min-h-[100px] resize-none",v.body&&"border-error focus:ring-error"),"aria-label":"Message content","aria-invalid":!!v.body,"aria-describedby":v.body?"body-error":void 0}),e.jsx("div",{className:"absolute bottom-2 right-2",children:e.jsxs("span",{className:N("text-caption",O?"text-error font-medium":"text-neutral-blue-gray/50"),children:[T," / ",A]})})]}),v.body&&e.jsx("p",{id:"body-error",className:"text-small text-error",children:v.body.message}),e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("input",{type:"file",id:"file-attachment",className:"hidden",accept:".pdf,.png,.jpg,.jpeg",multiple:!0,onChange:y,"aria-label":"Attach files"}),e.jsxs(I,{type:"button",variant:"outline",size:"sm",onClick:()=>document.getElementById("file-attachment")?.click(),disabled:d,children:[e.jsx(De,{className:"h-4 w-4 mr-2"}),"Attach File"]})]}),e.jsx(I,{type:"submit",disabled:d||!S?.trim(),className:"min-w-[120px]",children:d?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"animate-spin mr-2",children:"⏳"}),"Sending..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Ee,{className:"h-4 w-4 mr-2"}),"Send"]})})]})]})})}const qe={[i.PATIENT]:[i.DOCTOR,i.NURSE,i.RECEPTIONIST,i.BILLING_STAFF],[i.DOCTOR]:[i.PATIENT,i.DOCTOR,i.NURSE,i.RECEPTIONIST,i.ADMIN],[i.NURSE]:[i.PATIENT,i.DOCTOR,i.NURSE,i.RECEPTIONIST,i.ADMIN],[i.RECEPTIONIST]:[i.PATIENT,i.DOCTOR,i.NURSE,i.RECEPTIONIST,i.ADMIN],[i.BILLING_STAFF]:[i.PATIENT,i.BILLING_STAFF,i.ADMIN],[i.ADMIN]:[i.PATIENT,i.DOCTOR,i.NURSE,i.RECEPTIONIST,i.BILLING_STAFF,i.ADMIN]};function Ue(s){return qe[s]||[]}function Be(s,a){const l=Ue(s);return a.filter(u=>l.includes(u.role))}function ns({open:s,onOpenChange:a}){const{toast:l}=U(),u=B(),{user:t}=q(),[r,f]=w.useState(""),{data:n,isLoading:h}=Y({queryKey:["messageable-users"],queryFn:()=>D.getMessageableUsers(),enabled:s}),j=w.useMemo(()=>{if(!t||!n)return[];const o=n.filter(F=>F.id!==t.id);return Be(t.role,o)},[t,n]),{register:x,handleSubmit:v,formState:{errors:d},reset:g,watch:b,setValue:m}=W({resolver:Z(te),defaultValues:{recipientId:"",subject:"",body:""}}),c=G({mutationFn:o=>D.sendMessage(o),onSuccess:()=>{u.invalidateQueries({queryKey:["conversations"]}),l({title:"Message sent",description:"Your message has been sent successfully.",variant:"success"}),a(!1),g(),f("")},onError:o=>{l({title:"Failed to send message",description:o?.message||"Please try again.",variant:"destructive"})}}),y=o=>{if(console.log("Form submitted:",{data:o,selectedRecipientId:r}),!r){l({title:"Recipient required",description:"Please select a recipient to send the message to.",variant:"destructive"});return}console.log("Sending message to:",r),c.mutate({...o,recipientId:r})},E=o=>{f(o),m("recipientId",o)},S=o=>({patient:"Patient",doctor:"Doctor",nurse:"Nurse",receptionist:"Receptionist",billing_staff:"Billing Staff",admin:"Administrator"})[o]||o,T=b("body"),A=T?.length||0,O=5e3,p=A>O*.9;return e.jsx(oe,{open:s,onOpenChange:a,children:e.jsxs(de,{className:"sm:max-w-[600px]",children:[e.jsx(ue,{children:e.jsx(me,{children:"New Message"})}),e.jsxs("form",{onSubmit:v(y),className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(z,{htmlFor:"recipient",children:"To"}),h?e.jsx("div",{className:"text-small text-neutral-blue-gray/60",children:"Loading users..."}):e.jsxs(he,{value:r,onValueChange:E,children:[e.jsx(fe,{id:"recipient",children:e.jsx(xe,{placeholder:"Select a recipient"})}),e.jsx(ge,{children:j?.map(o=>e.jsxs(pe,{value:o.id,children:[o.firstName," ",o.lastName," - ",S(o.role)]},o.id))})]}),!r&&e.jsx("p",{className:"text-small text-neutral-blue-gray/60",children:"Select who you want to send a message to"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(z,{htmlFor:"subject",children:"Subject (Optional)"}),e.jsx(_,{id:"subject",...x("subject"),placeholder:"e.g., Question about medication",className:N(d.subject&&"border-error focus:ring-error")}),d.subject&&e.jsx("p",{className:"text-small text-error",children:d.subject.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(z,{htmlFor:"body",children:"Message"}),e.jsxs("div",{className:"relative",children:[e.jsx(se,{id:"body",...x("body"),placeholder:"Type your message here...",className:N("min-h-[150px] resize-none",d.body&&"border-error focus:ring-error")}),e.jsx("div",{className:"absolute bottom-2 right-2",children:e.jsxs("span",{className:N("text-caption",p?"text-error font-medium":"text-neutral-blue-gray/50"),children:[A," / ",O]})})]}),d.body&&e.jsx("p",{className:"text-small text-error",children:d.body.message})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-4",children:[e.jsx(I,{type:"button",variant:"outline",onClick:()=>{a(!1),g(),f("")},disabled:c.isPending,children:"Cancel"}),e.jsx(I,{type:"submit",disabled:c.isPending||!T?.trim()||!r,children:c.isPending?"Sending...":"Send Message"})]}),!1]})]})})}export{ts as C,as as M,ns as N,rs as S};
